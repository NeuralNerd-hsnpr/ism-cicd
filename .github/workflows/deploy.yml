name: CD - Deploy to Server

on:
  push:
    branches: [ "develop" ]

jobs:
  deploy:
    runs-on: self-hosted
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4

    - name: Deploy on Self-Hosted Runner
      run: |
        # 1. Get Short SHA
        SHORT_SHA=$(echo "${{ github.sha }}" | cut -c1-7)
        echo "Deploying commit: $SHORT_SHA"

        # 2. Build Unified Docker Image
        # We use --network host to ensure build process has internet access
        docker build -t unified-ai-service:$SHORT_SHA .

        # 3. Stop and Remove Existing Container
        docker stop ai-service || true
        docker rm ai-service || true

        # 4. Run New Container
        # --net host: Simplifies port mapping (8000-8007 exposed directly)
        # --gpus all: Enables GPU access
        # --restart always: Auto-restart on crash/reboot
        # -v ~/.cache/huggingface:/root/.cache/huggingface: Persist HF models
        # -v $(pwd)/logs:/app/logs: Persist logs
        docker run -d \
          --name ai-service \
          --net host \
          --gpus all \
          --restart always \
          -v ~/.cache/huggingface:/root/.cache/huggingface \
          -v $(pwd)/logs:/app/logs \
          unified-ai-service:$SHORT_SHA

        # 5. Prune unused images to save space (keep only the current one ideally, but prune -f is safer)
        docker image prune -f
